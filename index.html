<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–ª–æ—Å–æ–≤–æ–π DeepSeek</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: white;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        h1 {
            text-align: center;
            margin-top: 0;
            font-size: 2.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .btn {
            display: block;
            width: 100%;
            padding: 20px;
            font-size: 1.5rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(1px);
        }
        .btn.listening {
            background: #f44336;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }
        .status {
            text-align: center;
            font-size: 1.1rem;
            min-height: 25px;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .chat-area {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
        }
        .message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 15px;
            max-width: 90%;
            word-wrap: break-word;
        }
        .user-message {
            background: #4e54c8;
            margin-left: auto;
        }
        .ai-message {
            background: #333;
            margin-right: auto;
        }
        .settings {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .settings input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: none;
            background: rgba(0,0,0,0.4);
            color: white;
        }
        .voice-select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: none;
            background: rgba(0,0,0,0.4);
            color: white;
        }
        .permission-panel {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff5555;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .permission-btn {
            background: #ff5722;
            margin: 10px auto;
            max-width: 300px;
        }
        footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }
        .instructions {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        .instructions h3 {
            margin-top: 0;
        }
        .instructions ul {
            padding-left: 20px;
            margin-bottom: 0;
        }
        .retry-btn {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.8rem;
            }
            .btn {
                padding: 15px;
                font-size: 1.2rem;
            }
            .permission-panel {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† –ì–æ–ª–æ—Å–æ–≤–æ–π DeepSeek</h1>
        
        <div id="permissionPanel" class="permission-panel">
            <h3>‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</h3>
            <p>–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.</p>
            <button id="requestPermissionBtn" class="btn permission-btn">–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</button>
            <div class="instructions">
                <h3>üì± –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Android:</h3>
                <ol>
                    <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ</li>
                    <li>–í –ø–æ—è–≤–∏–≤—à–µ–º—Å—è –æ–∫–Ω–µ –≤—ã–±–µ—Ä–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å"</li>
                    <li>–ï—Å–ª–∏ –æ–∫–Ω–æ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
                        <ul>
                            <li>–ë—Ä–∞—É–∑–µ—Ä Chrome –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏</li>
                            <li>–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Chrome ‚Üí –†–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–∞–π—Ç–æ–≤ ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω</li>
                            <li>–°–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –ø–æ HTTPS (–∞–¥—Ä–µ—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å https://)</li>
                        </ul>
                    </li>
                </ol>
            </div>
        </div>
        
        <div id="appContent" style="display: none;">
            <div class="settings">
                <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <input type="text" id="deepseekApiKey" placeholder="DeepSeek API Key (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                
                <select id="voiceSelect" class="voice-select">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–ª–æ—Å --</option>
                </select>
                
                <label>
                    <input type="checkbox" id="autoScroll" checked> –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
                </label>
            </div>
            
            <button id="startBtn" class="btn">üé§ –ù–∞–∂–º–∏ –∏ –≥–æ–≤–æ—Ä–∏</button>
            
            <div class="status" id="status">–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
            
            <div class="chat-area" id="chatArea">
                <div class="message ai-message">–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –≥–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ DeepSeek. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ —Å–æ –º–Ω–æ–π!</div>
            </div>
            
            <div class="instructions">
                <h3>üìå –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</h3>
                <ul>
                    <li>–ü–æ–ª—É—á–∏—Ç–µ API-–∫–ª—é—á –Ω–∞ <a href="https://platform.deepseek.com/" target="_blank" style="color: #4fc3f7;">platform.deepseek.com</a></li>
                    <li>–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á –≤ –ø–æ–ª–µ –≤—ã—à–µ</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ —á—ë—Ç–∫–æ –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω</li>
                    <li>–û—Ç–≤–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ —á–∞—Ç–µ –∏ –±—É–¥–µ—Ç –æ–∑–≤—É—á–µ–Ω</li>
                </ul>
            </div>
        </div>
        
        <footer>
            –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Ä¢ –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤ ‚Ä¢ –î–ª—è –ª–∏—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        </footer>
    </div>

    <script>
        // =====================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        // =====================
        const DEFAULT_DEEPSEEK_API_KEY = "";

        // =====================
        // –≠–õ–ï–ú–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê
        // =====================
        const startBtn = document.getElementById('startBtn');
        const statusEl = document.getElementById('status');
        const chatArea = document.getElementById('chatArea');
        const deepseekApiKeyInput = document.getElementById('deepseekApiKey');
        const voiceSelect = document.getElementById('voiceSelect');
        const autoScrollCheckbox = document.getElementById('autoScroll');
        const permissionPanel = document.getElementById('permissionPanel');
        const appContent = document.getElementById('appContent');
        const requestPermissionBtn = document.getElementById('requestPermissionBtn');

        // =====================
        // –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // =====================
        let isRecording = false;
        let recognition;
        let voices = [];
        let selectedVoice = null;
        let microphoneAccessGranted = false;

        // =====================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // =====================
        window.onload = async function() {
            deepseekApiKeyInput.value = DEFAULT_DEEPSEEK_API_KEY;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º
            checkBrowserSupport();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
            await checkMicrophonePermission();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
            loadVoices();
            speechSynthesis.onvoiceschanged = loadVoices;
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
            loadSettings();
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º
        function checkBrowserSupport() {
            let supportMessage = "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: ";
            let allSupported = true;
            
            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                supportMessage += "–ù–ï–¢ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏, ";
                allSupported = false;
            } else {
                supportMessage += "–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏, ";
            }
            
            if (!('speechSynthesis' in window)) {
                supportMessage += "–ù–ï–¢ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏";
                allSupported = false;
            } else {
                supportMessage += "–°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏";
            }
            
            if (!allSupported) {
                statusEl.textContent = supportMessage;
                addMessageToChat("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Chrome –∏–ª–∏ Edge.", "ai");
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω
        async function checkMicrophonePermission() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Permissions API
                if (navigator.permissions) {
                    const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
                    microphoneAccessGranted = permissionStatus.state === 'granted';
                    
                    permissionStatus.onchange = () => {
                        microphoneAccessGranted = permissionStatus.state === 'granted';
                        updateUI();
                    };
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ getUserMedia
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    microphoneAccessGranted = true;
                } catch (error) {
                    microphoneAccessGranted = false;
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π:", e);
                microphoneAccessGranted = false;
            }
            
            updateUI();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        function updateUI() {
            if (microphoneAccessGranted) {
                permissionPanel.style.display = 'none';
                appContent.style.display = 'block';
            } else {
                permissionPanel.style.display = 'block';
                appContent.style.display = 'none';
            }
        }

        // –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
        requestPermissionBtn.addEventListener('click', async () => {
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                microphoneAccessGranted = true;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                updateUI();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                statusEl.textContent = "–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É —Ä–∞–∑—Ä–µ—à–µ–Ω!";
                addMessageToChat("–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É —Ä–∞–∑—Ä–µ—à–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞.", "ai");
                
            } catch (error) {
                let errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø: ";
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += "–í—ã –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ –¥–æ—Å—Ç—É–ø. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.";
                } else if (error.name === 'NotFoundError') {
                    errorMessage += "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.";
                } else if (error.name === 'SecurityError') {
                    errorMessage += "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω –∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.";
                } else {
                    errorMessage += error.message;
                }
                
                permissionPanel.innerHTML += `<div class="status" style="color: #ff5555; margin-top: 15px;">${errorMessage}</div>`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
                if (!document.getElementById('retryPermissionBtn')) {
                    const retryBtn = document.createElement('button');
                    retryBtn.id = 'retryPermissionBtn';
                    retryBtn.className = 'retry-btn';
                    retryBtn.textContent = "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞";
                    retryBtn.onclick = () => location.reload();
                    permissionPanel.appendChild(retryBtn);
                }
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            voiceSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–ª–æ—Å --</option>';
            
            const russianVoices = voices.filter(voice => 
                voice.lang.startsWith('ru') || voice.lang.startsWith('RU')
            );
            
            const preferredVoices = [
                'Google —Ä—É—Å—Å–∫–∏–π',
                'Microsoft Irina - Russian',
                'Yandex',
                'Russian'
            ];
            
            russianVoices.sort((a, b) => {
                const aIndex = preferredVoices.findIndex(name => a.name.includes(name));
                const bIndex = preferredVoices.findIndex(name => b.name.includes(name));
                return (bIndex === -1 ? 999 : bIndex) - (aIndex === -1 ? 999 : aIndex);
            });
            
            russianVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });
            
            if (russianVoices.length > 0 && !selectedVoice) {
                voiceSelect.value = russianVoices[0].name;
                selectedVoice = russianVoices[0];
            }
        }

        // =====================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–¨–Æ
        // =====================
        startBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        function startRecording() {
            const apiKey = deepseekApiKeyInput.value.trim();
            if (!apiKey) {
                statusEl.textContent = "–û—à–∏–±–∫–∞: –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á DeepSeek";
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                statusEl.textContent = "–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏";
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = () => {
                isRecording = true;
                startBtn.textContent = "‚èπÔ∏è –°–ª—É—à–∞—é...";
                startBtn.classList.add('listening');
                statusEl.textContent = "–ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å...";
                
                const retryBtn = document.getElementById('retryBtn');
                if (retryBtn) retryBtn.remove();
            };
            
            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                statusEl.textContent = `–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "${transcript}"`;
                addMessageToChat(transcript, "user");
                
                const response = await sendToDeepSeek(transcript);
                
                if (response) {
                    addMessageToChat(response, "ai");
                    speakText(response);
                }
            };
            
            recognition.onerror = (event) => {
                let errorMessage = `–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ${event.error}`;
                
                if (event.error === 'not-allowed') {
                    errorMessage = "–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞:";
                    errorMessage += "\n1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–Ω–∞—á–æ–∫ üîí –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ";
                    errorMessage += "\n2. –í—ã–±–µ—Ä–∏—Ç–µ '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞'";
                    errorMessage += "\n3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ '–†–∞–∑—Ä–µ—à–∏—Ç—å'";
                    errorMessage += "\n4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É";
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–æ—Å—Ç—É–ø–∞
                    microphoneAccessGranted = false;
                    updateUI();
                } else if (event.error === 'no-speech') {
                    errorMessage = "–†–µ—á—å –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
                } else if (event.error === 'audio-capture') {
                    errorMessage = "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω.";
                } else if (event.error === 'network') {
                    errorMessage = "–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.";
                }
                
                statusEl.innerHTML = errorMessage.replace(/\n/g, '<br>');
                stopRecording();
                
                if (!document.getElementById('retryBtn')) {
                    const retryBtn = document.createElement('button');
                    retryBtn.id = 'retryBtn';
                    retryBtn.className = 'retry-btn';
                    retryBtn.textContent = "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞";
                    retryBtn.onclick = () => location.reload();
                    statusEl.parentNode.insertBefore(retryBtn, statusEl.nextSibling);
                }
            };
            
            recognition.onend = () => {
                stopRecording();
            };
            
            try {
                // –ó–∞–ø—É—Å–∫ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
                setTimeout(() => {
                    recognition.start();
                }, 100);
            } catch (error) {
                if (error.message.includes('without user gesture')) {
                    statusEl.innerHTML = "–û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–ø–∏—Å—å —Å–Ω–æ–≤–∞!<br>Android —Ç—Ä–µ–±—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –ø–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è";
                } else {
                    statusEl.textContent = "–û—à–∏–±–∫–∞: " + error.message;
                }
                stopRecording();
            }
        }

        function stopRecording() {
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ:", e);
                }
            }
            
            isRecording = false;
            startBtn.textContent = "üé§ –ù–∞–∂–º–∏ –∏ –≥–æ–≤–æ—Ä–∏";
            startBtn.classList.remove('listening');
            
            if (statusEl.textContent.includes("–ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å")) {
                statusEl.textContent = "–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
            }
        }

        // =====================
        // –û–ë–†–ê–©–ï–ù–ò–ï –ö DEEPSEEK API
        // =====================
        async function sendToDeepSeek(text) {
            const apiKey = deepseekApiKeyInput.value.trim();
            
            if (!apiKey) {
                statusEl.textContent = "–û—à–∏–±–∫–∞: API –∫–ª—é—á –Ω–µ –∑–∞–¥–∞–Ω";
                return null;
            }
            
            statusEl.textContent = "–û–±—â–µ–Ω–∏–µ —Å DeepSeek...";
            
            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {
                                role: "user",
                                content: text
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 2000,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`–û—à–∏–±–∫–∞ API: ${response.status} - ${errorData.error?.message || response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    statusEl.textContent = "–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω!";
                    return data.choices[0].message.content;
                } else {
                    throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç DeepSeek");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", error);
                statusEl.textContent = "–û—à–∏–±–∫–∞: " + error.message;
                addMessageToChat("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.", "ai");
                return null;
            }
        }

        // =====================
        // –°–ò–ù–¢–ï–ó –†–ï–ß–ò (TTS)
        // =====================
        function speakText(text) {
            const selectedVoiceName = voiceSelect.value;
            if (selectedVoiceName) {
                selectedVoice = voices.find(voice => voice.name === selectedVoiceName);
            }
            
            if (!voices.length) {
                voices = speechSynthesis.getVoices();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ru-RU';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            utterance.onstart = () => {
                statusEl.textContent = "–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ...";
            };
            
            utterance.onend = () => {
                statusEl.textContent = "–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ";
            };
            
            utterance.onerror = (event) => {
                console.error("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏:", event);
                statusEl.textContent = "–û—à–∏–±–∫–∞ –æ–∑–≤—É—á–∫–∏";
            };
            
            speechSynthesis.speak(utterance);
        }

        // =====================
        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // =====================
        function addMessageToChat(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = text;
            chatArea.appendChild(messageDiv);
            
            if (autoScrollCheckbox.checked) {
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        function saveSettings() {
            const settings = {
                apiKey: deepseekApiKeyInput.value,
                voice: voiceSelect.value,
                autoScroll: autoScrollCheckbox.checked
            };
            localStorage.setItem('voiceAssistantSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('voiceAssistantSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                deepseekApiKeyInput.value = settings.apiKey || '';
                voiceSelect.value = settings.voice || '';
                autoScrollCheckbox.checked = settings.autoScroll !== false;
                
                if (settings.voice) {
                    selectedVoice = voices.find(v => v.name === settings.voice) || null;
                }
            }
        }

        deepseekApiKeyInput.addEventListener('input', saveSettings);
        voiceSelect.addEventListener('change', () => {
            const voiceName = voiceSelect.value;
            selectedVoice = voices.find(v => v.name === voiceName) || null;
            saveSettings();
        });
        autoScrollCheckbox.addEventListener('change', saveSettings);
    </script>
</body>
</html>
