<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–ª–æ—Å–æ–≤–æ–π DeepSeek</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: white;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        h1 {
            text-align: center;
            margin-top: 0;
            font-size: 2.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .btn {
            display: block;
            width: 100%;
            padding: 20px;
            font-size: 1.5rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(1px);
        }
        .btn.listening {
            background: #f44336;
            animation: pulse 1.5s infinite;
        }
        .btn.secondary {
            background: #2196F3;
            padding: 15px;
            font-size: 1.2rem;
            margin: 10px 0;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }
        .status {
            text-align: center;
            font-size: 1.1rem;
            min-height: 25px;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .chat-area {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
        }
        .message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 15px;
            max-width: 90%;
            word-wrap: break-word;
        }
        .user-message {
            background: #4e54c8;
            margin-left: auto;
        }
        .ai-message {
            background: #333;
            margin-right: auto;
        }
        .permission-panel {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff5555;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .permission-btn {
            background: #ff5722;
            margin: 10px auto;
            max-width: 300px;
        }
        footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }
        .instructions {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        .instructions h3 {
            margin-top: 0;
        }
        .instructions ul {
            padding-left: 20px;
            margin-bottom: 0;
        }
        .retry-btn {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        .iframe-container {
            display: none;
            width: 100%;
            height: 500px;
            border: 1px solid #444;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }
        .auth-container {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .auth-status {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
        }
        .auth-success {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
        }
        .auth-error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
        }
        .hidden {
            display: none;
        }
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.8rem;
            }
            .btn {
                padding: 15px;
                font-size: 1.2rem;
            }
            .permission-panel {
                padding: 15px;
            }
            .iframe-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† –ì–æ–ª–æ—Å–æ–≤–æ–π DeepSeek</h1>
        
        <div id="permissionPanel" class="permission-panel">
            <h3>‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</h3>
            <p>–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.</p>
            <button id="requestPermissionBtn" class="btn permission-btn">–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</button>
            <div class="instructions">
                <h3>üì± –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Android:</h3>
                <ol>
                    <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ</li>
                    <li>–í –ø–æ—è–≤–∏–≤—à–µ–º—Å—è –æ–∫–Ω–µ –≤—ã–±–µ—Ä–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å"</li>
                    <li>–ï—Å–ª–∏ –æ–∫–Ω–æ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
                        <ul>
                            <li>–ë—Ä–∞—É–∑–µ—Ä Chrome –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏</li>
                            <li>–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Chrome ‚Üí –†–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–∞–π—Ç–æ–≤ ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω</li>
                            <li>–°–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –ø–æ HTTPS (–∞–¥—Ä–µ—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å https://)</li>
                        </ul>
                    </li>
                </ol>
            </div>
        </div>
        
        <div id="appContent" style="display: none;">
            <div class="auth-container">
                <h3>üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ DeepSeek</h3>
                <div id="authStatus" class="auth-status hidden"></div>
                <button id="loginBtn" class="btn secondary">–í–æ–π—Ç–∏ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç</button>
                <button id="logoutBtn" class="btn secondary hidden">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
                <div id="userInfo" class="auth-status hidden"></div>
            </div>
            
            <button id="startBtn" class="btn">üé§ –ù–∞–∂–º–∏ –∏ –≥–æ–≤–æ—Ä–∏</button>
            
            <div class="status" id="status">–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
            
            <div class="chat-area" id="chatArea">
                <div class="message ai-message">–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –≥–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ DeepSeek. –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ!</div>
            </div>
            
            <div class="iframe-container" id="iframeContainer">
                <iframe id="deepseekIframe" src="https://chat.deepseek.com"></iframe>
            </div>
            
            <div class="instructions">
                <h3>üìå –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</h3>
                <ul>
                    <li>–ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç" –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ —á–µ—Ç–∫–æ</li>
                    <li>–í–∞—à –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ DeepSeek Chat</li>
                    <li>–û—Ç–≤–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ —á–∞—Ç–µ –∏ –±—É–¥–µ—Ç –æ–∑–≤—É—á–µ–Ω</li>
                    <li>–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∞—Ç –≤–Ω–∏–∑—É</li>
                </ul>
            </div>
        </div>
        
        <footer>
            –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç ‚Ä¢ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
        </footer>
    </div>

    <script>
        // =====================
        // –≠–õ–ï–ú–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê
        // =====================
        const startBtn = document.getElementById('startBtn');
        const statusEl = document.getElementById('status');
        const chatArea = document.getElementById('chatArea');
        const permissionPanel = document.getElementById('permissionPanel');
        const appContent = document.getElementById('appContent');
        const requestPermissionBtn = document.getElementById('requestPermissionBtn');
        const iframeContainer = document.getElementById('iframeContainer');
        const deepseekIframe = document.getElementById('deepseekIframe');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authStatus = document.getElementById('authStatus');
        const userInfo = document.getElementById('userInfo');

        // =====================
        // –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // =====================
        let isRecording = false;
        let recognition;
        let voices = [];
        let selectedVoice = null;
        let microphoneAccessGranted = false;
        let chatHistory = [];
        let isAuthenticated = false;

        // =====================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // =====================
        window.onload = async function() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º
            checkBrowserSupport();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
            await checkMicrophonePermission();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
            loadVoices();
            speechSynthesis.onvoiceschanged = loadVoices;
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞ DeepSeek
            deepseekIframe.onload = () => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                setTimeout(checkAuthState, 3000);
            };
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function checkAuthState() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤—ã—Ö–æ–¥–∞
                const logoutButton = deepseekIframe.contentDocument.querySelector('button:contains("Logout"), button:contains("–í—ã–π—Ç–∏")');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userAvatar = deepseekIframe.contentDocument.querySelector('.user-avatar, .avatar');
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–ª–∏ –∞–≤–∞—Ç–∞—Ä - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                if (logoutButton || userAvatar) {
                    isAuthenticated = true;
                    authStatus.textContent = "–í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã! –ú–æ–∂–Ω–æ –æ–±—â–∞—Ç—å—Å—è";
                    authStatus.className = "auth-status auth-success";
                    authStatus.classList.remove('hidden');
                    loginBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    try {
                        const userNameEl = deepseekIframe.contentDocument.querySelector('.user-name, .username');
                        if (userNameEl) {
                            userInfo.textContent = `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ${userNameEl.textContent.trim()}`;
                            userInfo.classList.remove('hidden');
                        }
                    } catch (e) {
                        console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", e);
                    }
                } else {
                    isAuthenticated = false;
                    loginBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    userInfo.classList.add('hidden');
                }
            } catch (e) {
                console.log("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", e);
                isAuthenticated = false;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º
        function checkBrowserSupport() {
            let supportMessage = "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: ";
            let allSupported = true;
            
            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                supportMessage += "–ù–ï–¢ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏, ";
                allSupported = false;
            } else {
                supportMessage += "–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏, ";
            }
            
            if (!('speechSynthesis' in window)) {
                supportMessage += "–ù–ï–¢ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏";
                allSupported = false;
            } else {
                supportMessage += "–°–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏";
            }
            
            if (!allSupported) {
                statusEl.textContent = supportMessage;
                addMessageToChat("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Chrome –∏–ª–∏ Edge.", "ai");
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω
        async function checkMicrophonePermission() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Permissions API
                if (navigator.permissions) {
                    const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
                    microphoneAccessGranted = permissionStatus.state === 'granted';
                    
                    permissionStatus.onchange = () => {
                        microphoneAccessGranted = permissionStatus.state === 'granted';
                        updateUI();
                    };
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ getUserMedia
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    microphoneAccessGranted = true;
                } catch (error) {
                    microphoneAccessGranted = false;
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π:", e);
                microphoneAccessGranted = false;
            }
            
            updateUI();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        function updateUI() {
            if (microphoneAccessGranted) {
                permissionPanel.style.display = 'none';
                appContent.style.display = 'block';
            } else {
                permissionPanel.style.display = 'block';
                appContent.style.display = 'none';
            }
        }

        // –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
        requestPermissionBtn.addEventListener('click', async () => {
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                microphoneAccessGranted = true;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                updateUI();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                statusEl.textContent = "–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É —Ä–∞–∑—Ä–µ—à–µ–Ω!";
                addMessageToChat("–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É —Ä–∞–∑—Ä–µ—à–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞.", "ai");
                
            } catch (error) {
                let errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø: ";
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += "–í—ã –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ –¥–æ—Å—Ç—É–ø. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.";
                } else if (error.name === 'NotFoundError') {
                    errorMessage += "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.";
                } else if (error.name === 'SecurityError') {
                    errorMessage += "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω –∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.";
                } else {
                    errorMessage += error.message;
                }
                
                permissionPanel.innerHTML += `<div class="status" style="color: #ff5555; margin-top: 15px;">${errorMessage}</div>`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
                if (!document.getElementById('retryPermissionBtn')) {
                    const retryBtn = document.createElement('button');
                    retryBtn.id = 'retryPermissionBtn';
                    retryBtn.className = 'retry-btn';
                    retryBtn.textContent = "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞";
                    retryBtn.onclick = () => location.reload();
                    permissionPanel.appendChild(retryBtn);
                }
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            
            const russianVoices = voices.filter(voice => 
                voice.lang.startsWith('ru') || voice.lang.startsWith('RU')
            );
            
            const preferredVoices = [
                'Google —Ä—É—Å—Å–∫–∏–π',
                'Microsoft Irina - Russian',
                'Yandex',
                'Russian'
            ];
            
            russianVoices.sort((a, b) => {
                const aIndex = preferredVoices.findIndex(name => a.name.includes(name));
                const bIndex = preferredVoices.findIndex(name => b.name.includes(name));
                return (bIndex === -1 ? 999 : bIndex) - (aIndex === -1 ? 999 : aIndex);
            });
            
            if (russianVoices.length > 0 && !selectedVoice) {
                selectedVoice = russianVoices[0];
            }
        }

        // =====================
        // –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
        // =====================
        loginBtn.addEventListener('click', () => {
            iframeContainer.style.display = "block";
            authStatus.textContent = "–û—Ç–∫—Ä—ã—Ç —á–∞—Ç DeepSeek. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç...";
            authStatus.className = "auth-status";
            authStatus.classList.remove('hidden');
        });

        logoutBtn.addEventListener('click', () => {
            try {
                // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞ –≤ iframe
                const logoutButton = deepseekIframe.contentDocument.querySelector('button:contains("Logout"), button:contains("–í—ã–π—Ç–∏")');
                
                if (logoutButton) {
                    logoutButton.click();
                    authStatus.textContent = "–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞";
                    authStatus.className = "auth-status";
                    userInfo.classList.add('hidden');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(checkAuthState, 2000);
                } else {
                    authStatus.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞. –í—ã–π–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –≤ —á–∞—Ç–µ.";
                    authStatus.className = "auth-status auth-error";
                }
            } catch (e) {
                console.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:", e);
                authStatus.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
                authStatus.className = "auth-status auth-error";
            }
        });

        // =====================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–¨–Æ
        // =====================
        startBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        function startRecording() {
            if (!isAuthenticated) {
                authStatus.textContent = "–û—à–∏–±–∫–∞: –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç DeepSeek!";
                authStatus.className = "auth-status auth-error";
                authStatus.classList.remove('hidden');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                statusEl.textContent = "–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏";
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = () => {
                isRecording = true;
                startBtn.textContent = "‚èπÔ∏è –°–ª—É—à–∞—é...";
                startBtn.classList.add('listening');
                statusEl.textContent = "–ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å...";
            };
            
            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                statusEl.textContent = `–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "${transcript}"`;
                addMessageToChat(transcript, "user");
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
                if (transcript.toLowerCase().includes("–ø–æ–∫–∞–∂–∏ —á–∞—Ç")) {
                    iframeContainer.style.display = "block";
                    addMessageToChat("–ß–∞—Ç DeepSeek —Ç–µ–ø–µ—Ä—å –≤–∏–¥–µ–Ω. –í—ã –º–æ–∂–µ—Ç–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –Ω–∏–º –Ω–∞–ø—Ä—è–º—É—é.", "ai");
                    speakText("–ß–∞—Ç DeepSeek —Ç–µ–ø–µ—Ä—å –≤–∏–¥–µ–Ω. –í—ã –º–æ–∂–µ—Ç–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –Ω–∏–º –Ω–∞–ø—Ä—è–º—É—é.");
                    return;
                }
                
                if (transcript.toLowerCase().includes("—Å–∫—Ä–æ–π —á–∞—Ç")) {
                    iframeContainer.style.display = "none";
                    addMessageToChat("–ß–∞—Ç DeepSeek —Å–∫—Ä—ã—Ç.", "ai");
                    speakText("–ß–∞—Ç DeepSeek —Å–∫—Ä—ã—Ç.");
                    return;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç DeepSeek
                iframeContainer.style.display = "block";
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –≤ —á–∞—Ç DeepSeek
                try {
                    // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                    const inputField = deepseekIframe.contentDocument.querySelector('textarea');
                    if (inputField) {
                        inputField.focus();
                        
                        // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
                        inputField.value = transcript;
                        
                        // –ò–º–∏—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ input –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
                        const event = new Event('input', { bubbles: true });
                        inputField.dispatchEvent(event);
                        
                        // –ù–∞–∂–∏–º–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                        const sendButton = deepseekIframe.contentDocument.querySelector('button[data-testid="send-button"]');
                        if (sendButton) {
                            sendButton.click();
                            
                            // –û–∂–∏–¥–∞–µ–º –æ—Ç–≤–µ—Ç
                            statusEl.textContent = "–û–∂–∏–¥–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç DeepSeek...";
                            waitForResponse();
                        } else {
                            throw new Error("–ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
                        }
                    } else {
                        throw new Error("–ü–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å —á–∞—Ç–æ–º:", error);
                    statusEl.textContent = "–û—à–∏–±–∫–∞: " + error.message;
                    addMessageToChat("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", "ai");
                    speakText("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
                }
            };
            
            recognition.onerror = (event) => {
                let errorMessage = `–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ${event.error}`;
                
                if (event.error === 'not-allowed') {
                    errorMessage = "–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞:";
                    errorMessage += "\n1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–Ω–∞—á–æ–∫ üîí –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ";
                    errorMessage += "\n2. –í—ã–±–µ—Ä–∏—Ç–µ '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞'";
                    errorMessage += "\n3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ '–†–∞–∑—Ä–µ—à–∏—Ç—å'";
                    errorMessage += "\n4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É";
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–æ—Å—Ç—É–ø–∞
                    microphoneAccessGranted = false;
                    updateUI();
                } else if (event.error === 'no-speech') {
                    errorMessage = "–†–µ—á—å –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
                } else if (event.error === 'audio-capture') {
                    errorMessage = "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω.";
                } else if (event.error === 'network') {
                    errorMessage = "–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.";
                }
                
                statusEl.innerHTML = errorMessage.replace(/\n/g, '<br>');
                stopRecording();
            };
            
            recognition.onend = () => {
                stopRecording();
            };
            
            try {
                // –ó–∞–ø—É—Å–∫ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
                setTimeout(() => {
                    recognition.start();
                }, 100);
            } catch (error) {
                statusEl.textContent = "–û—à–∏–±–∫–∞: " + error.message;
                stopRecording();
            }
        }

        function stopRecording() {
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ:", e);
                }
            }
            
            isRecording = false;
            startBtn.textContent = "üé§ –ù–∞–∂–º–∏ –∏ –≥–æ–≤–æ—Ä–∏";
            startBtn.classList.remove('listening');
        }

        // –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç DeepSeek
        function waitForResponse() {
            let attempts = 0;
            const maxAttempts = 30; // –ú–∞–∫—Å–∏–º—É–º 15 —Å–µ–∫—É–Ω–¥ –æ–∂–∏–¥–∞–Ω–∏—è
            
            const checkInterval = setInterval(() => {
                attempts++;
                
                try {
                    // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –≤ —á–∞—Ç–µ
                    const messages = deepseekIframe.contentDocument.querySelectorAll('.message');
                    if (messages.length > 0) {
                        const lastMessage = messages[messages.length - 1];
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç DeepSeek
                        if (lastMessage.querySelector('.bot-message') || 
                            lastMessage.textContent.includes('DeepSeek')) {
                            
                            const responseText = lastMessage.querySelector('.message-content, .content')?.textContent || 
                                                lastMessage.textContent;
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ —á–∞—Ç
                            addMessageToChat(responseText, "ai");
                            speakText(responseText);
                            
                            statusEl.textContent = "–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω!";
                            clearInterval(checkInterval);
                        }
                    }
                    
                    // –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
                    if (attempts >= maxAttempts) {
                        statusEl.textContent = "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞";
                        addMessageToChat("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å.", "ai");
                        speakText("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å.");
                        clearInterval(checkInterval);
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞:", error);
                    statusEl.textContent = "–û—à–∏–±–∫–∞: " + error.message;
                    clearInterval(checkInterval);
                }
            }, 500); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 500 –º—Å
        }

        // =====================
        // –°–ò–ù–¢–ï–ó –†–ï–ß–ò (TTS)
        // =====================
        function speakText(text) {
            if (!text) return;
            
            if (!voices.length) {
                voices = speechSynthesis.getVoices();
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
            speechSynthesis.cancel();
            
            // –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏
            const maxLength = 200;
            if (text.length > maxLength) {
                // –ì–æ–≤–æ—Ä–∏–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å
                const firstPart = text.substring(0, maxLength);
                const utterance = createUtterance(firstPart);
                speechSynthesis.speak(utterance);
                
                // –ì–æ–≤–æ—Ä–∏–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –ø–µ—Ä–≤–æ–π
                utterance.onend = () => {
                    const remainingText = text.substring(maxLength);
                    if (remainingText.length > 0) {
                        setTimeout(() => speakText(remainingText), 300);
                    }
                };
            } else {
                const utterance = createUtterance(text);
                speechSynthesis.speak(utterance);
            }
        }
        
        function createUtterance(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ru-RU';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            utterance.onstart = () => {
                statusEl.textContent = "–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ...";
            };
            
            utterance.onend = () => {
                statusEl.textContent = "–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ";
            };
            
            utterance.onerror = (event) => {
                console.error("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏:", event);
                statusEl.textContent = "–û—à–∏–±–∫–∞ –æ–∑–≤—É—á–∫–∏";
            };
            
            return utterance;
        }

        // =====================
        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // =====================
        function addMessageToChat(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = text;
            chatArea.appendChild(messageDiv);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
            chatArea.scrollTop = chatArea.scrollHeight;
        }
    </script>
</body>
</html>
