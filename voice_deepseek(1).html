<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–ª–æ—Å–æ–≤–æ–π DeepSeek</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: white;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        h1 {
            text-align: center;
            margin-top: 0;
            font-size: 2.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .btn {
            display: block;
            width: 100%;
            padding: 20px;
            font-size: 1.5rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(1px);
        }
        .btn.listening {
            background: #f44336;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }
        .status {
            text-align: center;
            font-size: 1.1rem;
            min-height: 25px;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .chat-area {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
        }
        .message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 15px;
            max-width: 90%;
            word-wrap: break-word;
        }
        .user-message {
            background: #4e54c8;
            margin-left: auto;
        }
        .ai-message {
            background: #333;
            margin-right: auto;
        }
        .settings {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .settings input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: none;
            background: rgba(0,0,0,0.4);
            color: white;
        }
        .voice-select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: none;
            background: rgba(0,0,0,0.4);
            color: white;
        }
        footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }
        .instructions {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        .instructions h3 {
            margin-top: 0;
        }
        .instructions ul {
            padding-left: 20px;
            margin-bottom: 0;
        }
        .retry-btn {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 1.8rem;
            }
            .btn {
                padding: 15px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† –ì–æ–ª–æ—Å–æ–≤–æ–π DeepSeek</h1>
        
        <div class="settings">
            <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <input type="text" id="deepseekApiKey" placeholder="DeepSeek API Key (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            
            <select id="voiceSelect" class="voice-select">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–ª–æ—Å --</option>
            </select>
            
            <label>
                <input type="checkbox" id="autoScroll" checked> –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            </label>
        </div>
        
        <button id="startBtn" class="btn">üé§ –ù–∞–∂–º–∏ –∏ –≥–æ–≤–æ—Ä–∏</button>
        
        <div class="status" id="status">–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
        
        <div class="chat-area" id="chatArea">
            <div class="message ai-message">–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –≥–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ DeepSeek. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ —Å–æ –º–Ω–æ–π!</div>
        </div>
        
        <div class="instructions">
            <h3>üìå –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</h3>
            <ul>
                <li>–ü–æ–ª—É—á–∏—Ç–µ API-–∫–ª—é—á –Ω–∞ <a href="https://platform.deepseek.com/" target="_blank" style="color: #4fc3f7;">platform.deepseek.com</a></li>
                <li>–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á –≤ –ø–æ–ª–µ –≤—ã—à–µ</li>
                <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ —á—ë—Ç–∫–æ –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω</li>
                <li>–û—Ç–≤–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ —á–∞—Ç–µ –∏ –±—É–¥–µ—Ç –æ–∑–≤—É—á–µ–Ω</li>
                <li><b>–í–∞–∂–Ω–æ:</b> –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ HTTPS (–ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä)</li>
            </ul>
        </div>
        
        <footer>
            –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Ä¢ –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤ ‚Ä¢ –î–ª—è –ª–∏—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        </footer>
    </div>

    <script>
        // =====================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        // =====================
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∑–¥–µ—Å—å –≤–∞—à API-–∫–ª—é—á DeepSeek –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        const DEFAULT_DEEPSEEK_API_KEY = "";

        // =====================
        // –≠–õ–ï–ú–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê
        // =====================
        const startBtn = document.getElementById('startBtn');
        const statusEl = document.getElementById('status');
        const chatArea = document.getElementById('chatArea');
        const deepseekApiKeyInput = document.getElementById('deepseekApiKey');
        const voiceSelect = document.getElementById('voiceSelect');
        const autoScrollCheckbox = document.getElementById('autoScroll');

        // =====================
        // –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // =====================
        let isRecording = false;
        let recognition;
        let voices = [];
        let selectedVoice = null;

        // =====================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // =====================
        window.onload = function() {
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ API –∫–ª—é—á–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            deepseekApiKeyInput.value = DEFAULT_DEEPSEEK_API_KEY;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º
            checkBrowserSupport();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
            loadVoices();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –ø—Ä–∏ –∏—Ö –∑–∞–≥—Ä—É–∑–∫–µ
            speechSynthesis.onvoiceschanged = loadVoices;
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
            loadSettings();
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
        function checkBrowserSupport() {
            let supportMessage = "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: ";
            let allSupported = true;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ Web Speech Recognition
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                supportMessage += "–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏, ";
            } else {
                supportMessage += "–ù–ï–¢ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏, ";
                allSupported = false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ Web Speech Synthesis
            if ('speechSynthesis' in window) {
                supportMessage += "–°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏";
            } else {
                supportMessage += "–ù–ï–¢ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏";
                allSupported = false;
            }
            
            statusEl.textContent = supportMessage;
            
            if (!allSupported) {
                startBtn.disabled = true;
                addMessageToChat("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Chrome –∏–ª–∏ Edge.", "ai");
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            voiceSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–ª–æ—Å --</option>';
            
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä—É—Å—Å–∫–∏—Ö –≥–æ–ª–æ—Å–æ–≤
            const russianVoices = voices.filter(voice => 
                voice.lang.startsWith('ru') || voice.lang.startsWith('RU')
            );
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞—á–µ—Å—Ç–≤—É/–ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—é
            const preferredVoices = [
                'Google —Ä—É—Å—Å–∫–∏–π',
                'Microsoft Irina - Russian',
                'Yandex',
                'Russian'
            ];
            
            russianVoices.sort((a, b) => {
                const aIndex = preferredVoices.findIndex(name => a.name.includes(name));
                const bIndex = preferredVoices.findIndex(name => b.name.includes(name));
                return (bIndex === -1 ? 999 : bIndex) - (aIndex === -1 ? 999 : aIndex);
            });
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤ –≤ —Å–ø–∏—Å–æ–∫
            russianVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });
            
            // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–≥–æ —Ä—É—Å—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–∞
            if (russianVoices.length > 0 && !selectedVoice) {
                voiceSelect.value = russianVoices[0].name;
                selectedVoice = russianVoices[0];
            }
        }

        // =====================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–¨–Æ
        // =====================
        startBtn.addEventListener('click', async () => {
            if (isRecording) {
                stopRecording();
            } else {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º
                try {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ç–æ–∫ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
                    stream.getTracks().forEach(track => track.stop());
                    
                    // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø –µ—Å—Ç—å, –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å—å
                    startRecording();
                } catch (error) {
                    let errorMessage = "–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ";
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage += "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.";
                    } else {
                        errorMessage += error.message;
                    }
                    
                    statusEl.textContent = errorMessage;
                    addMessageToChat("‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É", "ai");
                    
                    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
                    if (!document.getElementById('retryBtn')) {
                        const retryBtn = document.createElement('button');
                        retryBtn.id = 'retryBtn';
                        retryBtn.className = 'retry-btn';
                        retryBtn.textContent = "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞";
                        retryBtn.onclick = () => location.reload();
                        statusEl.parentNode.insertBefore(retryBtn, statusEl.nextSibling);
                    }
                }
            }
        });

        function startRecording() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
            const apiKey = deepseekApiKeyInput.value.trim();
            if (!apiKey) {
                statusEl.textContent = "–û—à–∏–±–∫–∞: –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á DeepSeek";
                return;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
            if (!SpeechRecognition) {
                statusEl.textContent = "–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏";
                return;
            }
            
            recognition = new SpeechRecognition();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
            recognition.lang = 'ru-RU';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            recognition.onstart = () => {
                isRecording = true;
                startBtn.textContent = "‚èπÔ∏è –°–ª—É—à–∞—é...";
                startBtn.classList.add('listening');
                statusEl.textContent = "–ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å...";
                
                // –£–¥–∞–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                const retryBtn = document.getElementById('retryBtn');
                if (retryBtn) retryBtn.remove();
            };
            
            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                statusEl.textContent = `–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "${transcript}"`;
                addMessageToChat(transcript, "user");
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ DeepSeek
                const response = await sendToDeepSeek(transcript);
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ —á–∞—Ç –∏ –æ–∑–≤—É—á–∫–∞
                if (response) {
                    addMessageToChat(response, "ai");
                    speakText(response);
                }
            };
            
            recognition.onerror = (event) => {
                let errorMessage = `–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ${event.error}`;
                
                // –ë–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
                if (event.error === 'not-allowed') {
                    errorMessage = "–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.";
                } else if (event.error === 'no-speech') {
                    errorMessage = "–†–µ—á—å –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
                } else if (event.error === 'audio-capture') {
                    errorMessage = "–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω.";
                }
                
                statusEl.textContent = errorMessage;
                stopRecording();
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
                if (!document.getElementById('retryBtn')) {
                    const retryBtn = document.createElement('button');
                    retryBtn.id = 'retryBtn';
                    retryBtn.className = 'retry-btn';
                    retryBtn.textContent = "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞";
                    retryBtn.onclick = () => location.reload();
                    statusEl.parentNode.insertBefore(retryBtn, statusEl.nextSibling);
                }
            };
            
            recognition.onend = () => {
                stopRecording();
            };
            
            // –ó–∞–ø—É—Å–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
            try {
                recognition.start();
            } catch (error) {
                statusEl.textContent = "–û—à–∏–±–∫–∞: " + error.message;
                stopRecording();
            }
        }

        function stopRecording() {
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ:", e);
                }
            }
            
            isRecording = false;
            startBtn.textContent = "üé§ –ù–∞–∂–º–∏ –∏ –≥–æ–≤–æ—Ä–∏";
            startBtn.classList.remove('listening');
            
            if (statusEl.textContent.includes("–ì–æ–≤–æ—Ä–∏—Ç–µ —Å–µ–π—á–∞—Å")) {
                statusEl.textContent = "–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
            }
        }

        // =====================
        // –û–ë–†–ê–©–ï–ù–ò–ï –ö DEEPSEEK API
        // =====================
        async function sendToDeepSeek(text) {
            const apiKey = deepseekApiKeyInput.value.trim();
            
            if (!apiKey) {
                statusEl.textContent = "–û—à–∏–±–∫–∞: API –∫–ª—é—á –Ω–µ –∑–∞–¥–∞–Ω";
                return null;
            }
            
            statusEl.textContent = "–û–±—â–µ–Ω–∏–µ —Å DeepSeek...";
            
            try {
                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {
                                role: "user",
                                content: text
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 2000,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`–û—à–∏–±–∫–∞ API: ${response.status} - ${errorData.error?.message || response.statusText}`);
                }
                
                const data = await response.json();
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    statusEl.textContent = "–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω!";
                    return data.choices[0].message.content;
                } else {
                    throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç DeepSeek");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", error);
                statusEl.textContent = "–û—à–∏–±–∫–∞: " + error.message;
                addMessageToChat("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.", "ai");
                return null;
            }
        }

        // =====================
        // –°–ò–ù–¢–ï–ó –†–ï–ß–ò (TTS)
        // =====================
        function speakText(text) {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ–ª–æ—Å–∞
            const selectedVoiceName = voiceSelect.value;
            if (selectedVoiceName) {
                selectedVoice = voices.find(voice => voice.name === selectedVoiceName);
            }
            
            // –ï—Å–ª–∏ –≥–æ–ª–æ—Å–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø–æ–ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
            if (!voices.length) {
                voices = speechSynthesis.getVoices();
            }
            
            // –°–æ–∑–¥–∞–Ω–∏–µ utterance
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ru-RU';
            utterance.rate = 1.0; // –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏
            utterance.pitch = 1.0; // –¢–æ–Ω –≥–æ–ª–æ—Å–∞
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            utterance.onstart = () => {
                statusEl.textContent = "–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ...";
            };
            
            utterance.onend = () => {
                statusEl.textContent = "–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ";
            };
            
            utterance.onerror = (event) => {
                console.error("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏:", event);
                statusEl.textContent = "–û—à–∏–±–∫–∞ –æ–∑–≤—É—á–∫–∏";
            };
            
            // –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
            speechSynthesis.speak(utterance);
        }

        // =====================
        // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
        // =====================
        function addMessageToChat(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = text;
            chatArea.appendChild(messageDiv);
            
            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –æ–ø—Ü–∏–∏
            if (autoScrollCheckbox.checked) {
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ LocalStorage
        function saveSettings() {
            const settings = {
                apiKey: deepseekApiKeyInput.value,
                voice: voiceSelect.value,
                autoScroll: autoScrollCheckbox.checked
            };
            localStorage.setItem('voiceAssistantSettings', JSON.stringify(settings));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ LocalStorage
        function loadSettings() {
            const savedSettings = localStorage.getItem('voiceAssistantSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                deepseekApiKeyInput.value = settings.apiKey || '';
                voiceSelect.value = settings.voice || '';
                autoScrollCheckbox.checked = settings.autoScroll !== false;
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ–ª–æ—Å–∞
                if (settings.voice) {
                    selectedVoice = voices.find(v => v.name === settings.voice) || null;
                }
            }
        }

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        deepseekApiKeyInput.addEventListener('input', saveSettings);
        voiceSelect.addEventListener('change', () => {
            const voiceName = voiceSelect.value;
            selectedVoice = voices.find(v => v.name === voiceName) || null;
            saveSettings();
        });
        autoScrollCheckbox.addEventListener('change', saveSettings);
    </script>
</body>
</html>